name: Documentation Sanity Check
on:
  pull_request:
    paths:
      - "**.md"
      - "docs/**"
      - "TASKS.md"
  push:
    branches: [main]
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday at midnight
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  sanity-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Check Core Documentation
        run: |
          echo "ðŸ“š Checking core documentation files..."

          ERRORS=0
          WARNINGS=0

          # Core documentation files that must exist
          REQUIRED_DOCS=(
            "README.md"
            "CONTRIBUTING.md"
            "SECURITY.md"
            "CODE_OF_CONDUCT.md"
            "LICENSE"
            "TASKS.md"
            "FRAMEWORK.md"
            "QUALITY_STANDARDS.md"
            "CONVENTIONS.md"
          )

          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ -f "$doc" ]; then
              echo "  âœ“ $doc"
            else
              echo "  âŒ Missing: $doc"
              ERRORS=$((ERRORS + 1))
            fi
          done

          # Check for stale timestamps
          echo ""
          echo "ðŸ“… Checking documentation freshness..."

          # TASKS.md should be updated recently
          if [ -f "TASKS.md" ]; then
            last_modified=$(stat -c %Y TASKS.md 2>/dev/null || stat -f %m TASKS.md 2>/dev/null)
            now=$(date +%s)
            days_old=$(( (now - last_modified) / 86400 ))
            
            if [ $days_old -gt 30 ]; then
              echo "  âš ï¸  TASKS.md is $days_old days old (consider updating)"
              WARNINGS=$((WARNINGS + 1))
            else
              echo "  âœ“ TASKS.md is fresh ($days_old days old)"
            fi
          fi

          echo "ERRORS=$ERRORS" >> $GITHUB_ENV
          echo "WARNINGS=$WARNINGS" >> $GITHUB_ENV

      - name: Check ADRs
        run: |
          echo "ðŸ“‹ Checking ADR consistency..."

          # Count ADRs
          adr_count=$(find docs/adr -name "ADR-[0-9]*.md" 2>/dev/null | wc -l)
          echo "  Found $adr_count ADRs"

          # Check ADR README
          if [ -f "docs/adr/README.md" ]; then
            echo "  âœ“ ADR README exists"
            
            # Check if README mentions all ADRs
            for adr in docs/adr/ADR-[0-9]*.md; do
              if [ -f "$adr" ]; then
                adr_name=$(basename "$adr")
                if ! grep -q "$adr_name" docs/adr/README.md; then
                  echo "  âš ï¸  $adr_name not linked in README"
                  WARNINGS=$((WARNINGS + 1))
                fi
              fi
            done
          else
            echo "  âŒ docs/adr/README.md missing"
            ERRORS=$((ERRORS + 1))
          fi

          echo "ERRORS=$ERRORS" >> $GITHUB_ENV
          echo "WARNINGS=$WARNINGS" >> $GITHUB_ENV

      - name: Check Templates
        run: |
          echo "ðŸ“¦ Checking template structure..."

          REQUIRED_TEMPLATES=(
            "templates/python-service"
            "templates/node-service"
            "templates/react-webapp"
            "templates/go-service"
            "templates/docs-only"
          )

          for template in "${REQUIRED_TEMPLATES[@]}"; do
            if [ -d "$template" ]; then
              echo "  âœ“ $template"
              
              # Check for cookiecutter.json
              if [ ! -f "$template/cookiecutter.json" ]; then
                echo "    âš ï¸  Missing cookiecutter.json"
                WARNINGS=$((WARNINGS + 1))
              fi
              
              # Check for hooks
              if [ ! -d "$template/hooks" ]; then
                echo "    âš ï¸  Missing hooks directory"
                WARNINGS=$((WARNINGS + 1))
              fi
            else
              echo "  âš ï¸  Missing: $template"
              WARNINGS=$((WARNINGS + 1))
            fi
          done

          echo "ERRORS=$ERRORS" >> $GITHUB_ENV
          echo "WARNINGS=$WARNINGS" >> $GITHUB_ENV

      - name: Check Issue Templates
        run: |
          echo "ðŸŽ« Checking issue templates..."

          if [ ! -d ".github/ISSUE_TEMPLATE" ]; then
            echo "  âŒ .github/ISSUE_TEMPLATE directory missing"
            ERRORS=$((ERRORS + 1))
          else
            echo "  âœ“ Issue template directory exists"
            
            REQUIRED_TEMPLATES=(
              "bug_report.md"
              "feature_request.md"
              "task.md"
              "adr_proposal.md"
            )
            
            for template in "${REQUIRED_TEMPLATES[@]}"; do
              if [ -f ".github/ISSUE_TEMPLATE/$template" ]; then
                echo "    âœ“ $template"
              else
                echo "    âš ï¸  Missing: $template"
                WARNINGS=$((WARNINGS + 1))
              fi
            done
            
            # Check for config.yml
            if [ -f ".github/ISSUE_TEMPLATE/config.yml" ]; then
              echo "    âœ“ config.yml"
            else
              echo "    âš ï¸  Missing config.yml"
              WARNINGS=$((WARNINGS + 1))
            fi
          fi

          echo "ERRORS=$ERRORS" >> $GITHUB_ENV
          echo "WARNINGS=$WARNINGS" >> $GITHUB_ENV

      - name: Check TASKS.md Consistency
        run: |
          echo "ðŸ“ Checking TASKS.md consistency..."

          if [ ! -f "TASKS.md" ]; then
            echo "  âŒ TASKS.md not found"
            exit 1
          fi

          # Check for unchecked items without issue links
          unchecked=$(grep -c "^- \[ \] [^#]" TASKS.md || true)

          if [ $unchecked -gt 0 ]; then
            echo "  âš ï¸  Found $unchecked unchecked items without issue links"
            echo "     Consider running tasklist-scan workflow to create issues"
            WARNINGS=$((WARNINGS + 1))
          else
            echo "  âœ“ All unchecked items have issue links"
          fi

          # Check for "SINGLE SOURCE OF TRUTH" marker
          if grep -q "SINGLE SOURCE OF TRUTH" TASKS.md; then
            echo "  âœ“ TASKS.md marked as single source of truth"
          else
            echo "  âš ï¸  TASKS.md should be marked as single source of truth"
            WARNINGS=$((WARNINGS + 1))
          fi

          echo "ERRORS=$ERRORS" >> $GITHUB_ENV
          echo "WARNINGS=$WARNINGS" >> $GITHUB_ENV

      - name: Summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š Documentation Sanity Check Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Errors: $ERRORS"
          echo "âš ï¸  Warnings: $WARNINGS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ $ERRORS -gt 0 ]; then
            echo "âŒ Documentation sanity check failed"
            exit 1
          elif [ $WARNINGS -gt 0 ]; then
            echo "âš ï¸  Documentation sanity check passed with warnings"
          else
            echo "âœ… All documentation checks passed!"
          fi

      - name: Create issue for stale docs (scheduled only)
        if: github.event_name == 'schedule' && env.WARNINGS > 5
        uses: actions/github-script@v8
        with:
          script: |
            const warnings = parseInt(process.env.WARNINGS);

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ“š Documentation maintenance needed',
              body: `## Documentation Sanity Check Alert
              
              The weekly documentation sanity check found **${warnings} warnings**.
              
              This suggests that documentation may need updating or maintenance.
              
              **Recommended Actions:**
              1. Review TASKS.md and ensure it's up to date
              2. Check that all ADRs are linked in docs/adr/README.md
              3. Verify issue templates are complete
              4. Run the tasklist-scan workflow to sync unchecked items
              
              **Details:**
              - Run date: ${new Date().toISOString()}
              - Warnings: ${warnings}
              
              See the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.
              `,
              labels: ['documentation', 'maintenance', 'automated']
            });

            console.log(`Created issue #${issue.data.number}`);

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: MkDocs Build and Validation
        run: |
          echo "ðŸ“– Running MkDocs build --strict and front-matter validation..."

          # Build MkDocs with strict mode
          if mkdocs build --strict; then
            echo "  âœ“ MkDocs build --strict passed"
          else
            echo "  âŒ MkDocs build --strict failed"
            ERRORS=$((ERRORS + 1))
          fi

          # Validate front-matter in documentation files
          echo ""
          echo "ðŸ” Validating front-matter in documentation files..."

          # Find all markdown files in docs/ directory
          find docs/ -name "*.md" -type f | while read -r file; do
            # Check if file has front-matter (starts with ---)
            if head -1 "$file" | grep -q "^---$"; then
              # Extract front-matter
              front_matter=$(sed -n '/^---$/,/^---$/p' "$file" | head -n -1 | tail -n +2)
              
              # Basic validation: check for required fields
              if echo "$front_matter" | grep -q "^title:"; then
                echo "  âœ“ $file has title in front-matter"
              else
                echo "  âš ï¸  $file missing title in front-matter"
                WARNINGS=$((WARNINGS + 1))
              fi
              
              # Check for description
              if echo "$front_matter" | grep -q "^description:"; then
                echo "  âœ“ $file has description in front-matter"
              else
                echo "  âš ï¸  $file missing description in front-matter"
                WARNINGS=$((WARNINGS + 1))
              fi
              
              # Validate YAML syntax
              if echo "$front_matter" | python3 -c "
              import sys
              import yaml
              try:
                  yaml.safe_load(sys.stdin)
                  print('YAML_VALID')
              except yaml.YAMLError as e:
                  print(f'YAML_ERROR: {e}')
              " 2>/dev/null | grep -q "YAML_VALID"; then
                echo "  âœ“ $file has valid YAML front-matter"
              else
                echo "  âŒ $file has invalid YAML front-matter"
                ERRORS=$((ERRORS + 1))
              fi
            else
              echo "  âš ï¸  $file has no front-matter"
              WARNINGS=$((WARNINGS + 1))
            fi
          done

          echo "ERRORS=$ERRORS" >> $GITHUB_ENV
          echo "WARNINGS=$WARNINGS" >> $GITHUB_ENV
