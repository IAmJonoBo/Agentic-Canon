name: Issue Triage
on:
  issues:
    types: [opened]
permissions:
  issues: write
jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const issue = context.payload.issue;
            const labels = [];

            // Add needs-triage label to all new issues
            labels.push('needs-triage');

            // Auto-label based on title/body keywords
            const text = (issue.title + ' ' + issue.body).toLowerCase();

            // Type labels
            if (text.includes('bug') || text.includes('error') || text.includes('fail')) {
              labels.push('bug', 'type:bug');
            }
            if (text.includes('feature') || text.includes('enhancement') || text.includes('add')) {
              labels.push('enhancement', 'type:feature');
            }
            if (text.includes('[task]')) {
              labels.push('task', 'type:task');
            }
            if (text.includes('[adr]') || text.includes('architecture decision')) {
              labels.push('adr', 'architecture', 'needs-review');
            }

            // Topic labels
            if (text.includes('doc') || text.includes('readme') || text.includes('documentation')) {
              labels.push('documentation');
            }
            if (text.includes('security') || text.includes('vulnerability') || text.includes('cve')) {
              labels.push('security', 'critical');
            }
            if (text.includes('performance') || text.includes('slow') || text.includes('optimization')) {
              labels.push('performance');
            }
            if (text.includes('question') || text.includes('how to') || text.includes('help')) {
              labels.push('question');
            }

            // Component labels
            if (text.includes('template') || text.includes('cookiecutter')) {
              labels.push('component:templates');
            }
            if (text.includes('notebook') || text.includes('jupyter')) {
              labels.push('component:notebooks');
            }
            if (text.includes('cli') || text.includes('agentic-canon')) {
              labels.push('component:cli');
            }
            if (text.includes('ci') || text.includes('workflow') || text.includes('github actions')) {
              labels.push('component:ci-cd');
            }
            if (text.includes('test') && !text.includes('testing infrastructure')) {
              labels.push('component:testing');
            }

            // Apply labels
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              });
            }

            // Add comment with next steps
            const priorityGuide = labels.includes('critical') || labels.includes('security') ? 
              '\n**âš ï¸ This issue has been marked as high priority and will be reviewed urgently.**\n' : '';

            const componentGuide = labels.filter(l => l.startsWith('component:')).length > 0 ?
              '\n**ðŸŽ¯ Component:** ' + labels.filter(l => l.startsWith('component:')).map(l => l.replace('component:', '')).join(', ') : '';

            await github.rest.issues.createComment({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ‘‹ Thank you for opening this issue!\n\n' +
                'This issue has been automatically triaged and labeled. A maintainer will review it soon.\n' +
                priorityGuide + componentGuide + '\n\n' +
                '**Next steps:**\n' +
                '- Ensure you have provided all necessary information\n' +
                '- Check if a similar issue already exists\n' +
                '- For architectural decisions, consider creating an ADR (Architecture Decision Record)\n' +
                '- Link related issues or PRs if applicable\n\n' +
                '**For contributors:**\n' +
                '- Read our [CONTRIBUTING.md](../CONTRIBUTING.md) guide\n' +
                '- Check our [Code of Conduct](../CODE_OF_CONDUCT.md)\n' +
                '- Review [FRAMEWORK.md](../FRAMEWORK.md) for our development philosophy\n' +
                '- See [QUALITY_STANDARDS.md](../QUALITY_STANDARDS.md) for quality gates'
            });
