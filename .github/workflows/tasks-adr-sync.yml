name: Tasks and ADR Sync
on:
  schedule:
    - cron: "0 6 * * 1" # Weekly on Monday at 6 AM
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  sync-tasks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Sync TASKS.md with Issues
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            console.log('ğŸ“Š Syncing TASKS.md with GitHub Issues...');

            // Read TASKS.md
            const tasksPath = 'TASKS.md';
            if (!fs.existsSync(tasksPath)) {
              console.log('âŒ TASKS.md not found');
              return;
            }

            let content = fs.readFileSync(tasksPath, 'utf8');

            // Find all issue references in TASKS.md
            const issuePattern = /#(\d+)/g;
            const issueNumbers = [...content.matchAll(issuePattern)].map(m => parseInt(m[1]));

            console.log(`Found ${issueNumbers.length} issue references in TASKS.md`);

            let updates = 0;

            // Check each issue and update status if closed
            for (const issueNum of issueNumbers) {
              try {
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNum
                });
                
                if (issue.state === 'closed') {
                  // Find unchecked items with this issue number and mark them as checked
                  const pattern = new RegExp(`^- \\[ \\] #${issueNum}`, 'gm');
                  const newContent = content.replace(pattern, `- [x] #${issueNum}`);
                  
                  if (newContent !== content) {
                    console.log(`  âœ“ Marked issue #${issueNum} as completed (${issue.title})`);
                    content = newContent;
                    updates++;
                  }
                }
              } catch (error) {
                console.log(`  âš ï¸  Could not check issue #${issueNum}: ${error.message}`);
              }
            }

            // Write back if there were changes
            if (updates > 0) {
              fs.writeFileSync(tasksPath, content);
              console.log(`\nâœ… Updated ${updates} completed items in TASKS.md`);
            } else {
              console.log('\nâœ… TASKS.md is up to date');
            }

            return updates;

      - name: Check for new ADRs
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            console.log('ğŸ“‹ Checking for new ADRs...');

            const adrDir = 'docs/adr';
            const readmePath = path.join(adrDir, 'README.md');

            if (!fs.existsSync(readmePath)) {
              console.log('âŒ docs/adr/README.md not found');
              return;
            }

            const readme = fs.readFileSync(readmePath, 'utf8');

            // Find all ADR files
            const adrFiles = fs.readdirSync(adrDir)
              .filter(f => f.match(/^ADR-\d{3}-.+\.md$/))
              .sort();

            console.log(`Found ${adrFiles.length} ADR files`);

            // Parse ADR metadata for better issue creation
            const missingInReadme = [];
            const adrMetadata = {};

            for (const adrFile of adrFiles) {
              const adrPath = path.join(adrDir, adrFile);
              const content = fs.readFileSync(adrPath, 'utf8');
              
              // Extract metadata
              const metadata = {
                file: adrFile,
                title: '',
                status: 'unknown',
                date: '',
                number: adrFile.match(/ADR-(\d{3})/)?.[1] || ''
              };
              
              // Extract title from first heading
              const titleMatch = content.match(/^#\s+(.+)$/m);
              if (titleMatch) {
                metadata.title = titleMatch[1].replace(/^ADR-\d{3}:\s*/, '').trim();
              }
              
              // Extract status
              const statusMatch = content.match(/^status:\s*(.+)$/mi);
              if (statusMatch) {
                metadata.status = statusMatch[1].trim().toLowerCase();
              }
              
              // Extract date
              const dateMatch = content.match(/^date:\s*(.+)$/mi);
              if (dateMatch) {
                metadata.date = dateMatch[1].trim();
              }
              
              adrMetadata[adrFile] = metadata;
              
              // Check if in README
              if (!readme.includes(adrFile)) {
                missingInReadme.push(metadata);
              }
            }

            if (missingInReadme.length > 0) {
              console.log(`\nâš ï¸  Found ${missingInReadme.length} ADRs not linked in README:`);
              missingInReadme.forEach(m => console.log(`  - ${m.file}: ${m.title}`));
              
              // Build issue body
              let issueBody = '## ADRs Not Linked in README\n\n';
              issueBody += 'The following ADR files exist but are not linked in `docs/adr/README.md`:\n\n';
              
              for (const m of missingInReadme) {
                issueBody += `- [ ] **${m.file}**: ${m.title}\n`;
                issueBody += `  - **Status**: ${m.status}\n`;
                issueBody += `  - **Date**: ${m.date || 'Not specified'}\n`;
                issueBody += `  - **File**: [docs/adr/${m.file}](../docs/adr/${m.file})\n\n`;
              }
              
              issueBody += '## Action Required\n\n';
              issueBody += 'Please update `docs/adr/README.md` to include links to these ADRs in the appropriate section:\n\n';
              issueBody += '1. Review each ADR\'s status and content\n';
              issueBody += '2. Add links to the appropriate section in README.md based on status\n';
              issueBody += '3. Update the status summary counts\n';
              issueBody += '4. Ensure the "Total ADRs" count is accurate\n\n';
              issueBody += '## Context\n\n';
              issueBody += 'These ADRs were detected by the automated sync workflow. They exist in the `docs/adr/` directory but are not referenced in the main README, which could make them hard to discover.\n\n';
              issueBody += '**Automatically detected by:** Tasks and ADR Sync workflow on ' + new Date().toISOString().split('T')[0] + '\n';
              
              // Check if issue already exists
              const { data: existingIssues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'adr,documentation'
              });
              
              const hasIssue = existingIssues.some(i => 
                i.title.includes('ADRs Not Linked in README')
              );
              
              if (!hasIssue) {
                try {
                  const newIssue = await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: 'ğŸ“‹ ADRs Not Linked in README',
                    body: issueBody,
                    labels: ['adr', 'documentation', 'automated', 'priority:medium']
                  });
                  console.log(`âœ“ Created issue #${newIssue.data.number} to track missing ADR links`);
                  
                  // Build checklist comment
                  let checklistComment = '## Checklist for updating README\n\n';
                  
                  for (let i = 0; i < missingInReadme.length; i++) {
                    const m = missingInReadme[i];
                    checklistComment += `### ${i + 1}. ${m.file}\n\n`;
                    checklistComment += '- [ ] Review ADR content\n';
                    checklistComment += '- [ ] Determine appropriate section (Foundation, Observability, Security, etc.)\n';
                    checklistComment += '- [ ] Add link to README.md\n';
                    checklistComment += '- [ ] Update status counts if needed\n';
                    checklistComment += '- [ ] Verify link formatting\n\n';
                  }
                  
                  checklistComment += 'Once all items are complete, close this issue.';
                  
                  try {
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: newIssue.data.number,
                      body: checklistComment
                    });
                  } catch (error) {
                    console.log(`  âš ï¸  Failed to add comment: ${error.message}`);
                  }
                } catch (error) {
                  console.log(`  âŒ Failed to create issue: ${error.message}`);
                  if (error.status === 403 || error.status === 429) {
                    console.log(`  âš ï¸  Rate limited - issue creation skipped`);
                  }
                }
              } else {
                console.log('âš ï¸  Issue already exists for missing ADR links');
              }
            } else {
              console.log('âœ… All ADRs are linked in README');
            }

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet TASKS.md; then
            echo "No changes to commit"
          else
            git add TASKS.md
            git commit -m "chore: sync TASKS.md with closed issues [skip ci]"
            git push
            echo "âœ… Committed TASKS.md updates"
          fi

      - name: Enrich issues with ADR metadata
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            console.log('ğŸ”— Enriching issues with ADR metadata...');

            // Get all open issues with the from:tasklist label
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'from:tasklist',
              per_page: 100
            });

            console.log(`Found ${issues.length} open task issues`);

            // Rate limiting: Process in batches
            const MAX_ISSUES_PER_RUN = 20;
            const DELAY_BETWEEN_CALLS = 1000; // 1 second

            if (issues.length > MAX_ISSUES_PER_RUN) {
              console.log(`âš ï¸  Limiting to ${MAX_ISSUES_PER_RUN} issues per run to avoid rate limits`);
              issues.length = MAX_ISSUES_PER_RUN;
            }

            // Helper function for delay
            const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

            let enriched = 0;
            const adrDir = 'docs/adr';

            for (const issue of issues) {
              // Rate limiting: Add delay between operations
              if (enriched > 0) {
                await delay(DELAY_BETWEEN_CALLS);
              }
              
              // Check if issue already has ADR metadata in body
              if (issue.body && issue.body.includes('## Related ADRs')) {
                continue;
              }
              
              // Look for ADR references in the title
              const adrPattern = /ADR-(\d{3})/g;
              const adrRefs = [];
              let match;
              
              while ((match = adrPattern.exec(issue.title)) !== null) {
                adrRefs.push(`ADR-${match[1]}`);
              }
              
              // Also check TASKS.md for context
              if (fs.existsSync('TASKS.md')) {
                const tasksContent = fs.readFileSync('TASKS.md', 'utf8');
                const issueRefPattern = new RegExp(`#${issue.number}\\s+([^\\n]+)`, 'g');
                let taskMatch;
                
                while ((taskMatch = issueRefPattern.exec(tasksContent)) !== null) {
                  const taskLine = taskMatch[1];
                  let adrMatch;
                  while ((adrMatch = adrPattern.exec(taskLine)) !== null) {
                    const adrRef = `ADR-${adrMatch[1]}`;
                    if (!adrRefs.includes(adrRef)) {
                      adrRefs.push(adrRef);
                    }
                  }
                }
              }
              
              if (adrRefs.length > 0) {
                console.log(`  Enriching issue #${issue.number} with ${adrRefs.length} ADR references`);
                
                // Build ADR metadata
                let adrInfo = '\n\n## Related ADRs\n\n';
                adrInfo += 'This task is related to the following Architecture Decision Records:\n\n';
                
                for (const adrRef of adrRefs) {
                  const adrFile = `${adrRef}.md`;
                  const adrPath = path.join(adrDir, adrFile);
                  
                  if (fs.existsSync(adrPath)) {
                    const content = fs.readFileSync(adrPath, 'utf8');
                    const titleMatch = content.match(/^#\s+(.+)$/m);
                    const statusMatch = content.match(/^status:\s*(.+)$/mi);
                    
                    const title = titleMatch ? titleMatch[1] : adrRef;
                    const status = statusMatch ? statusMatch[1].trim() : 'unknown';
                    
                    adrInfo += `- [${adrRef}](../docs/adr/${adrRef}.md) - ${title.replace(/^ADR-\d{3}:\s*/, '')}\n`;
                    adrInfo += `  - Status: ${status}\n`;
                  } else {
                    adrInfo += `- ${adrRef} (file not found)\n`;
                  }
                }
                
                adrInfo += '\n**Note:** Please review these ADRs when working on this task to ensure alignment with architectural decisions.\n';
                
                // Update the issue body
                const newBody = (issue.body || '') + adrInfo;
                
                try {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: newBody
                  });
                  enriched++;
                } catch (error) {
                  console.log(`  âš ï¸  Failed to update issue #${issue.number}: ${error.message}`);
                  if (error.status === 403 || error.status === 429) {
                    console.log(`  âš ï¸  Rate limited, stopping enrichment for this run`);
                    break;
                  }
                }
              }
            }

            console.log(`\nâœ… Enriched ${enriched} issues with ADR metadata`);

      - name: Generate sync report
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ“Š Tasks and ADR Sync Report');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            // Count open vs closed items in TASKS.md
            if (fs.existsSync('TASKS.md')) {
              const content = fs.readFileSync('TASKS.md', 'utf8');
              const openTasks = (content.match(/^- \[ \]/gm) || []).length;
              const completedTasks = (content.match(/^- \[x\]/gm) || []).length;
              const total = openTasks + completedTasks;
              const completion = total > 0 ? ((completedTasks / total) * 100).toFixed(1) : 0;
              
              console.log(`\nğŸ“ TASKS.md Status:`);
              console.log(`  Total items: ${total}`);
              console.log(`  Completed: ${completedTasks}`);
              console.log(`  Open: ${openTasks}`);
              console.log(`  Completion: ${completion}%`);
            }

            // Count ADRs by status
            const adrDir = 'docs/adr';
            if (fs.existsSync(adrDir)) {
              const adrFiles = fs.readdirSync(adrDir)
                .filter(f => f.match(/^ADR-\d{3}-.+\.md$/));
              
              const statuses = { proposed: 0, accepted: 0, deprecated: 0, superseded: 0, unknown: 0 };
              
              for (const file of adrFiles) {
                const content = fs.readFileSync(`${adrDir}/${file}`, 'utf8');
                const statusMatch = content.match(/^status:\s*(\w+)/m);
                if (statusMatch) {
                  const status = statusMatch[1].toLowerCase();
                  statuses[status] = (statuses[status] || 0) + 1;
                } else {
                  statuses.unknown++;
                }
              }
              
              console.log(`\nğŸ“‹ ADR Status:`);
              console.log(`  Total ADRs: ${adrFiles.length}`);
              console.log(`  Proposed: ${statuses.proposed}`);
              console.log(`  Accepted: ${statuses.accepted}`);
              console.log(`  Deprecated: ${statuses.deprecated}`);
              console.log(`  Superseded: ${statuses.superseded}`);
              if (statuses.unknown > 0) {
                console.log(`  Unknown: ${statuses.unknown}`);
              }
            }

            console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('âœ… Sync completed successfully');
