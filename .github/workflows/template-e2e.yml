name: Templates â€¢ e2e

on:
  schedule:
    - cron: "0 3 * * 1"
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v6
        with:
          python-version: "3.14"
          cache: "pip"

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Configure cache directory
        run: |
          echo "AGENTIC_CANON_CACHE_DIR=${RUNNER_TEMP:-${TMPDIR:-/tmp}}/agentic-canon-cache" >> "$GITHUB_ENV"

      - name: Run template end-to-end tests
        env:
          CI: "true"
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt
          python .dev/scripts/sync-manifest.py --check
          pytest tests/test_template_e2e.py -m slow -v

  sanity-check:
    needs: e2e-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Run repository sanity check
        run: .dev/sanity-check.sh --quiet
