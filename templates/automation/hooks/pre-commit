# Pre-commit Git Hooks
# Enforces quality gates before commits
# Install: cp templates/automation/hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

#!/bin/bash

set -e

echo "ðŸ” Running pre-commit checks..."

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}âœ— Not a git repository${NC}"
    exit 1
fi

# Function to print colored output
print_status() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}âœ“ $2${NC}"
    else
        echo -e "${RED}âœ— $2${NC}"
        exit 1
    fi
}

# 1. Check for secrets in staged files
echo "Checking for secrets..."
if command -v gitleaks &> /dev/null; then
    gitleaks protect --staged
    print_status $? "No secrets detected"
else
    echo -e "${YELLOW}âš  Gitleaks not installed. Skipping secret scan.${NC}"
fi

# 2. Run linter
echo "Running linter..."
if [ -f "package.json" ]; then
    npm run lint --if-present
    print_status $? "Linting passed"
fi

# 3. Check code formatting
echo "Checking code formatting..."
if [ -f "package.json" ]; then
    npm run format:check --if-present
    print_status $? "Formatting is correct"
fi

# 4. Run unit tests
echo "Running unit tests..."
if [ -f "package.json" ]; then
    npm test --if-present
    print_status $? "All tests passed"
fi

# 5. Check commit message format
echo "Validating commit message..."
COMMIT_MSG_FILE=$1
if [ -f "$COMMIT_MSG_FILE" ]; then
    # Check conventional commits format
    if ! grep -qE "^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .{1,}" "$COMMIT_MSG_FILE"; then
        echo -e "${RED}âœ— Commit message must follow conventional commits format${NC}"
        echo -e "${YELLOW}Format: <type>[optional scope]: <description>${NC}"
        echo -e "${YELLOW}Example: feat(api): add user authentication${NC}"
        exit 1
    fi
fi

# 6. Check for TODO/FIXME in staged files
echo "Checking for unresolved TODOs..."
if git diff --cached --name-only | xargs grep -nHE "(TODO|FIXME)" 2>/dev/null; then
    echo -e "${YELLOW}âš  Found TODO/FIXME comments. Consider creating issues for them.${NC}"
fi

# 7. Check file sizes
echo "Checking file sizes..."
MAX_SIZE=$((5 * 1024 * 1024)) # 5MB
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file")
        if [ $size -gt $MAX_SIZE ]; then
            echo -e "${RED}âœ— File $file is larger than 5MB${NC}"
            exit 1
        fi
    fi
done
print_status 0 "All files are within size limits"

echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
exit 0
