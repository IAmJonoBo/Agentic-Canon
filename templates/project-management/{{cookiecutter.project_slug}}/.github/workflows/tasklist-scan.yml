name: Tasklists â†’ Issues
on:
  push:
    paths: ["TASKS.md", "docs/**.md", "**/*.md"]
permissions:
  contents: write
  issues: write
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'TASKS.md';
            if (!fs.existsSync(path)) { return; }
            let text = fs.readFileSync(path, 'utf8');
            const unchecked = [...text.matchAll(/^-\s\[\s\]\s+(.*)$/gm)].map(m => m[1].trim());
            for (const title of unchecked) {
              // Skip if already a tracked issue link
              if (/#\d+/.test(title)) continue;
              // De-dupe by existing issue title
              const { data: existing } = await github.rest.search.issuesAndPullRequests({
                q: `repo:${context.repo.owner}/${context.repo.repo} is:issue in:title "${title.replace(/"/g,'\\"')}"`
              });
              let number = existing.items.find(i => i.title === title)?.number;
              if (!number) {
                const created = await github.rest.issues.create({
                  owner: context.repo.owner, repo: context.repo.repo,
                  title, labels: ['task','from:tasklist']
                });
                number = created.data.number;
              }
              // Replace the line with a tracked-issue checkbox
              const safeTitle = title.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              const re = new RegExp(`^-\\s\\[\\s\\]\\s+${safeTitle}$`, 'm');
              text = text.replace(re, `- [ ] #${number} ${title}`);
            }
            fs.writeFileSync(path, text);
      - name: Commit back
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A && git diff --cached --quiet || git commit -m "chore: track checklist items as issues" && git push
